# Deployment Scripts - Quick Reference

This directory contains deployment and management scripts for BibleProject/Chancel.

## Deployment Modes

The deployment system supports two modes:

1. **Internal Database (Default)**: Deploys a PostgreSQL container as part of the stack
2. **External Database**: Uses an existing PostgreSQL database

Set the mode in `.env`:
```bash
USE_EXTERNAL_DB=false  # Use internal database (default)
USE_EXTERNAL_DB=true   # Use external database
```

## Prerequisites

- Docker installed
- docker-compose or docker compose (v2) installed
- Root/sudo access
- (External DB mode only) Running PostgreSQL instance

## Main Deployment Script

### Initial Deployment

```bash
sudo ./deploy.sh
```

This script will:
1. Check for Docker and docker-compose
2. Detect deployment mode from `.env` (internal or external database)
3. Create `.env` file from template if not exists (defaults to internal DB)
4. Generate secure secrets (NEXTAUTH_SECRET, DB_PASSWORD)
5. Verify database connectivity (external mode) or start database container (internal mode)
6. Build Docker images
7. Start application services (web, api)
8. Run database migrations
9. Optionally seed Bible data

**First time deployment takes 5-10 minutes** due to image building.

### Configuring Database Mode

**For Internal Database (Default - Recommended for new users):**
```bash
# .env file
USE_EXTERNAL_DB=false
DB_USER=chancel
DB_PASSWORD=<auto-generated>
DB_NAME=chancel
DB_PORT=5431
```

**For External Database (Advanced users with existing DB):**
```bash
# .env file
USE_EXTERNAL_DB=true
DB_USER=chancel
DB_PASSWORD=<your-existing-password>
DB_NAME=chancel
DB_PORT=5431  # Your existing DB port
```

The scripts automatically detect the mode and use the appropriate configuration.

## Management Scripts

### Check Status

```bash
sudo ./status.sh
```

Shows running containers, health checks, and access URLs.

### View Logs

```bash
# All services
sudo ./logs.sh

# Specific service
sudo ./logs.sh web
sudo ./logs.sh api
sudo ./logs.sh postgres
```

Press `Ctrl+C` to exit log viewing.

### Restart Services

```bash
# Restart all
sudo ./restart.sh

# Restart specific service
sudo ./restart.sh web
sudo ./restart.sh api
```

### Stop Services

```bash
sudo ./stop.sh
```

Will prompt to optionally remove volumes (data deletion).

## Database Management

### Database Shell

```bash
sudo ./db-manage.sh shell
```

Opens PostgreSQL psql shell.

### Backup Database

```bash
sudo ./db-manage.sh backup
```

Creates timestamped backup file: `backup_YYYYMMDD_HHMMSS.sql`

### Restore Database

```bash
sudo ./db-manage.sh restore backup_20241203_120000.sql
```

Restores database from backup file.

### Run Migrations

```bash
sudo ./db-manage.sh migrate
```

Applies pending Prisma migrations.

### Seed Bible Data

```bash
sudo ./db-manage.sh seed
```

Populates database with Bible verses (takes time).

### Prisma Studio

```bash
sudo ./db-manage.sh studio
```

Opens Prisma Studio at http://localhost:5555 for database browsing.

### Reset Database (⚠️ DANGER)

```bash
sudo ./db-manage.sh reset
```

Completely resets database - **DELETES ALL DATA**.

## Access Points

After successful deployment:

- **Web Application**: http://localhost:3000
- **GraphQL API**: http://localhost:4000/graphql
- **Database**: localhost:5431 (user: chancel)
- **Prisma Studio**: http://localhost:5555 (when running)

## Common Tasks

### Full Redeployment

```bash
sudo ./stop.sh        # Stop services
sudo ./deploy.sh      # Redeploy
```

### Update After Code Changes

```bash
sudo ./stop.sh
sudo ./deploy.sh      # Rebuilds images with --no-cache
```

### Check if Everything is Running

```bash
sudo ./status.sh
sudo ./logs.sh        # Check for errors
```

### Backup Before Updates

```bash
sudo ./db-manage.sh backup
# Then proceed with updates
```

## Troubleshooting

### Port Already in Use

Edit `.env` and change ports:
```bash
WEB_PORT=3001
API_PORT=4001
DB_PORT=5433
```

Then restart: `sudo ./restart.sh`

### Services Won't Start

```bash
# View detailed logs
sudo ./logs.sh

# Check Docker daemon
sudo systemctl status docker

# Check for port conflicts
sudo lsof -i :3000
sudo lsof -i :4000
sudo lsof -i :5431
```

### Database Connection Issues

```bash
# Check database health
sudo ./status.sh

# View database logs
sudo ./logs.sh postgres

# Try restarting database
sudo ./restart.sh postgres
```

### Complete Clean Rebuild

```bash
sudo ./stop.sh                    # Stop services
docker system prune -a -f         # Clean Docker
sudo ./deploy.sh                  # Rebuild everything
```

## Environment Configuration

Edit `.env` to customize:

```bash
# Deployment Mode
USE_EXTERNAL_DB=false  # Set to true for external database

# Database
DB_USER=chancel
DB_PASSWORD=<secure-password>
DB_NAME=chancel
DB_PORT=5431

# Application Ports
WEB_PORT=3000
API_PORT=4000

# Authentication
NEXTAUTH_SECRET=<secure-secret>
NEXTAUTH_URL=http://localhost:3000

# API
NEXT_PUBLIC_API_URL=http://localhost:4000/graphql
```

**Important**:
- The deployment mode is determined by `USE_EXTERNAL_DB` in `.env`
- Restart services after changing `.env`: `sudo ./restart.sh`
- For external DB, ensure your database container is running before deployment

## Security Notes

- `.env` contains sensitive secrets - never commit to git
- `deploy.sh` auto-generates secure secrets on first run
- Database password is randomized automatically
- Change default passwords in `.env` for production use

## Script Locations

All scripts are in the project root:

```
BibleProject/
├── .scripts-config.sh          # Common configuration (auto-loaded)
├── deploy.sh                   # Main deployment
├── stop.sh                     # Stop services
├── restart.sh                  # Restart services
├── status.sh                   # Check status
├── logs.sh                     # View logs
├── db-manage.sh                # Database operations
├── docker-compose.yml          # Internal DB configuration
├── docker-compose.external-db.yml  # External DB configuration
└── DEPLOYMENT.md               # This file
```

All scripts automatically detect and use the correct mode based on `.env`.

## Need Help?

1. Check logs: `sudo ./logs.sh`
2. Check status: `sudo ./status.sh`
3. Review DOCKER.md for detailed Docker info
4. Check docker-compose.yml for service configuration
