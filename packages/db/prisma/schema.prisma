generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  LEADER
  MEMBER
}

enum SessionVisibility {
  PUBLIC
  PRIVATE
}

enum SessionType {
  TOPIC_BASED
  SCRIPTURE_BASED
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?  // Full name (private by default)
  username        String?  @unique  // Public username (will be required after migration)
  displayName     String?  // Optional display name override
  password        String
  role            UserRole @default(MEMBER)

  // Email verification
  emailVerified          DateTime?  // Null if not verified
  emailVerificationToken String?    // Token for email verification

  // Profile fields
  bio             String?  @db.Text
  profilePicture  String?  // URL to profile image
  location        String?
  phoneNumber     String?

  // Preferences (stored as JSON)
  emailNotifications     Boolean @default(true)
  prayerNotifications    Boolean @default(true)
  commentNotifications   Boolean @default(true)
  bibleTranslation       String  @default("ESV")  // Preferred Bible translation

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessions              Session[]
  leadingSeries         Series[]
  comments              Comment[]
  sessionParticipants   SessionParticipant[]
  uploadedResources     SessionResource[]
  notifications         Notification[]
  chatMessages          ChatMessage[]
  sentJoinRequests      JoinRequest[]        @relation("SentRequests")
  receivedJoinRequests  JoinRequest[]        @relation("ReceivedRequests")
  prayerRequests        PrayerRequest[]
  prayerReactions       PrayerReaction[]
  leadingGroups         Group[]              @relation("GroupLeader")
  groupMemberships      GroupMember[]
  groupChatMessages     GroupChatMessage[]
  passageCompletions    PassageCompletion[]
  userAchievements      UserAchievement[]
  streak                UserStreak?
  achievementNotifications AchievementNotification[]

  @@index([email])
  @@index([username])
  @@index([emailVerificationToken])
}

model Series {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  imageUrl    String?
  leaderId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leader   User      @relation(fields: [leaderId], references: [id])
  sessions Session[]
  groupSeries GroupSeries[]

  @@index([leaderId])
}

model Session {
  id            String            @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime
  leaderId      String
  seriesId      String?
  visibility    SessionVisibility @default(PUBLIC)
  sessionType   SessionType       @default(SCRIPTURE_BASED) // Topic-based or Scripture-based study
  videoCallUrl  String?           // Jitsi Meet or other video call URL
  imageUrl      String?           // Optional session header image
  joinCode      String?           @unique // 6-character code for easy joining
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  leader               User                 @relation(fields: [leaderId], references: [id])
  series               Series?              @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  scripturePassages    ScripturePassage[]
  comments             Comment[]
  resources            SessionResource[]
  participants         SessionParticipant[]
  notifications        Notification[]
  chatMessages         ChatMessage[]
  joinRequests         JoinRequest[]
  groupSessions        GroupSession[]

  @@index([leaderId])
  @@index([seriesId])
  @@index([startDate])
  @@index([endDate])
  @@index([visibility])
  @@index([sessionType])
  @@index([joinCode])
}

model JoinRequest {
  id        String            @id @default(cuid())
  sessionId String
  fromId    String            // Leader who sends the request
  toId      String            // Member who receives the request
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  from    User    @relation("SentRequests", fields: [fromId], references: [id], onDelete: Cascade)
  to      User    @relation("ReceivedRequests", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([sessionId, toId])
  @@index([sessionId])
  @@index([fromId])
  @@index([toId])
  @@index([status])
}

model ScripturePassage {
  id         String   @id @default(cuid())
  sessionId  String
  book       String
  chapter    Int      // Starting chapter
  chapterEnd Int?     // Optional ending chapter for chapter ranges (e.g., Genesis 1-25)
  verseStart Int
  verseEnd   Int?
  content    String
  note       String?  @db.Text // Optional leader's note for this passage
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  session     Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  comments    Comment[]
  completions PassageCompletion[]

  @@index([sessionId])
  @@index([book, chapter])
}

// Track which passages users have marked as complete
model PassageCompletion {
  id         String   @id @default(cuid())
  passageId  String
  userId     String
  createdAt  DateTime @default(now())

  passage ScripturePassage @relation(fields: [passageId], references: [id], onDelete: Cascade)
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([passageId, userId])
  @@index([passageId])
  @@index([userId])
  @@index([userId, passageId])
}

model Comment {
  id         String   @id @default(cuid())
  passageId  String
  sessionId  String
  userId     String
  content    String
  verseNumber Int?    // Specific verse number within the passage for inline comments
  parentId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  passage      ScripturePassage @relation(fields: [passageId], references: [id], onDelete: Cascade)
  session      Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id])
  parent       Comment?         @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]        @relation("CommentThread")

  @@index([passageId])
  @@index([sessionId])
  @@index([userId])
  @@index([parentId])
  @@index([passageId, verseNumber])
  @@index([createdAt])
  @@index([passageId, parentId])
}

enum ResourceType {
  FILE
  VIDEO_UPLOAD
  VIDEO_YOUTUBE
  VIDEO_VIMEO
}

model SessionResource {
  id          String       @id @default(cuid())
  sessionId   String
  fileName    String
  fileUrl     String
  fileType    String
  resourceType ResourceType @default(FILE)
  videoId     String?      // YouTube/Vimeo video ID if applicable
  uploadedBy  String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  uploader User   @relation(fields: [uploadedBy], references: [id])

  @@index([sessionId])
  @@index([uploadedBy])
}

model SessionParticipant {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  role      UserRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([sessionId, userId])
  @@index([joinedAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  sessionId String
  type      String
  content   String
  sentAt    DateTime?
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([sentAt])
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
}

// Bible Library for pre-loaded scripture passages
model ScriptureLibrary {
  id         String   @id @default(cuid())
  book       String
  bookNumber Int      // For ordering (Genesis=1, Exodus=2, etc.)
  chapter    Int
  verseStart Int
  verseEnd   Int?
  content    String   @db.Text
  createdAt  DateTime @default(now())

  @@unique([book, chapter, verseStart, verseEnd])
  @@index([book, chapter])
  @@index([bookNumber, chapter])
}

enum ReactionType {
  HEART
  PRAYING_HANDS
}

enum GroupVisibility {
  PUBLIC
  PRIVATE
}

enum AchievementCategory {
  SCRIPTURE_READING
  SESSION_PARTICIPATION
  SESSION_COMPLETION
  COMMENTING
  GROUP_PARTICIPATION
  STREAK
  SPECIAL_EVENT
  HIDDEN
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum CriteriaType {
  COUNT
  STREAK
  MANUAL
  COMPOSITE
}

// Prayer Requests
model PrayerRequest {
  id          String   @id @default(cuid())
  userId      String
  content     String   @db.Text
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions PrayerReaction[]

  @@index([userId])
  @@index([createdAt])
}

model PrayerReaction {
  id              String       @id @default(cuid())
  prayerRequestId String
  userId          String
  reactionType    ReactionType
  createdAt       DateTime     @default(now())

  prayerRequest PrayerRequest @relation(fields: [prayerRequestId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([prayerRequestId, userId, reactionType])
  @@index([prayerRequestId])
  @@index([userId])
}

// Groups - Collections of users with chat and session assignment capabilities
model Group {
  id          String           @id @default(cuid())
  name        String
  description String?          @db.Text
  imageUrl    String?
  leaderId    String
  visibility  GroupVisibility  @default(PUBLIC)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  leader           User               @relation("GroupLeader", fields: [leaderId], references: [id])
  members          GroupMember[]
  chatMessages     GroupChatMessage[]
  groupSessions    GroupSession[]     // Sessions this group is assigned to
  groupSeries      GroupSeries[]      // Series this group is assigned to

  @@index([leaderId])
  @@index([visibility])
  @@index([createdAt])
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  role      UserRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupChatMessage {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([userId])
  @@index([createdAt])
}

// Junction table for assigning groups to sessions
model GroupSession {
  id        String   @id @default(cuid())
  groupId   String
  sessionId String
  addedAt   DateTime @default(now())

  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([groupId, sessionId])
  @@index([groupId])
  @@index([sessionId])
}

// Junction table for assigning groups to series
model GroupSeries {
  id        String   @id @default(cuid())
  groupId   String
  seriesId  String
  addedAt   DateTime @default(now())

  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([groupId, seriesId])
  @@index([groupId])
  @@index([seriesId])
}

// Achievements - Badge definitions
model Achievement {
  id              String              @id @default(cuid())
  code            String              @unique  // e.g., "READER_BRONZE", "STREAK_7_DAY"
  name            String              // e.g., "Bronze Reader"
  description     String              @db.Text // e.g., "Complete 5 scripture passages"
  iconUrl         String?             // URL to badge icon/image
  category        AchievementCategory
  tier            AchievementTier?    // NULL for special/streak/hidden badges
  criteriaType    CriteriaType
  criteriaValue   Int                 // Threshold to unlock (e.g., 5 passages)
  isHidden        Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  userAchievements UserAchievement[]
  notifications    AchievementNotification[]

  @@index([category])
  @@index([tier])
  @@index([isHidden])
  @@index([criteriaType])
}

// User Achievements - Tracks which badges users have unlocked
model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  progress      Int      @default(0)  // Current progress value when unlocked
  unlockedAt    DateTime @default(now())
  notified      Boolean  @default(false)  // Whether user was notified in-app

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([unlockedAt])
  @@index([userId, notified])
}

// User Streak - Tracks consecutive daily activity
model UserStreak {
  id               String   @id @default(cuid())
  userId           String   @unique
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityDate DateTime
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([currentStreak])
  @@index([lastActivityDate])
}

// Achievement Notifications - In-app notifications for badge unlocks
model AchievementNotification {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  read          Boolean  @default(false)
  createdAt     DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@index([userId, createdAt])
}
