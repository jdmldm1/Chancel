generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  LEADER
  MEMBER
}

enum SessionVisibility {
  PUBLIC
  PRIVATE
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions              Session[]
  leadingSeries         Series[]
  comments              Comment[]
  sessionParticipants   SessionParticipant[]
  uploadedResources     SessionResource[]
  notifications         Notification[]
  chatMessages          ChatMessage[]
  sentJoinRequests      JoinRequest[]        @relation("SentRequests")
  receivedJoinRequests  JoinRequest[]        @relation("ReceivedRequests")

  @@index([email])
}

model Series {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  imageUrl    String?
  leaderId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leader   User      @relation(fields: [leaderId], references: [id])
  sessions Session[]

  @@index([leaderId])
}

model Session {
  id            String            @id @default(cuid())
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime
  leaderId      String
  seriesId      String?
  visibility    SessionVisibility @default(PUBLIC)
  videoCallUrl  String?           // Jitsi Meet or other video call URL
  imageUrl      String?           // Optional session header image
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  leader               User                 @relation(fields: [leaderId], references: [id])
  series               Series?              @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  scripturePassages    ScripturePassage[]
  comments             Comment[]
  resources            SessionResource[]
  participants         SessionParticipant[]
  notifications        Notification[]
  chatMessages         ChatMessage[]
  joinRequests         JoinRequest[]

  @@index([leaderId])
  @@index([seriesId])
  @@index([startDate])
  @@index([endDate])
  @@index([visibility])
}

model JoinRequest {
  id        String            @id @default(cuid())
  sessionId String
  fromId    String            // Leader who sends the request
  toId      String            // Member who receives the request
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  from    User    @relation("SentRequests", fields: [fromId], references: [id], onDelete: Cascade)
  to      User    @relation("ReceivedRequests", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([sessionId, toId])
  @@index([sessionId])
  @@index([fromId])
  @@index([toId])
  @@index([status])
}

model ScripturePassage {
  id         String   @id @default(cuid())
  sessionId  String
  book       String
  chapter    Int
  verseStart Int
  verseEnd   Int?
  content    String
  note       String?  @db.Text // Optional leader's note for this passage
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  session  Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([sessionId])
  @@index([book, chapter])
}

model Comment {
  id         String   @id @default(cuid())
  passageId  String
  sessionId  String
  userId     String
  content    String
  verseNumber Int?    // Specific verse number within the passage for inline comments
  parentId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  passage      ScripturePassage @relation(fields: [passageId], references: [id], onDelete: Cascade)
  session      Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id])
  parent       Comment?         @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[]        @relation("CommentThread")

  @@index([passageId])
  @@index([sessionId])
  @@index([userId])
  @@index([parentId])
  @@index([passageId, verseNumber])
}

enum ResourceType {
  FILE
  VIDEO_UPLOAD
  VIDEO_YOUTUBE
  VIDEO_VIMEO
}

model SessionResource {
  id          String       @id @default(cuid())
  sessionId   String
  fileName    String
  fileUrl     String
  fileType    String
  resourceType ResourceType @default(FILE)
  videoId     String?      // YouTube/Vimeo video ID if applicable
  uploadedBy  String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  uploader User   @relation(fields: [uploadedBy], references: [id])

  @@index([sessionId])
  @@index([uploadedBy])
}

model SessionParticipant {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  role      UserRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  sessionId String
  type      String
  content   String
  sentAt    DateTime?
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([sentAt])
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
}
